<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Schemahanterare</title>

    <!-- iOS Web App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Schema">
    <meta name="format-detection" content="telephone=no">

    <!-- Theme color for iOS Safari -->
    <meta name="theme-color" content="#f8f6f1" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#0f0f1a" media="(prefers-color-scheme: dark)">

    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23e63946' width='100' height='100' rx='20'/><text x='50' y='68' font-size='50' text-anchor='middle' fill='white'>ðŸ“…</text></svg>">

    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --bg-primary: #f8f6f1;
            --bg-secondary: #ffffff;
            --bg-accent: #1a1a2e;
            --text-primary: #1a1a2e;
            --text-secondary: #5a5a7a;
            --accent: #e63946;
            --accent-light: #ff6b7a;
            --border: #e0ddd5;
            --success: #2a9d8f;
            --shadow: rgba(26, 26, 46, 0.08);
        }

        .dark {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-accent: #2a2a4e;
            --text-primary: #f8f6f1;
            --text-secondary: #a0a0b8;
            --border: #3a3a5e;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* Prevent tap highlight on iOS */
            -webkit-tap-highlight-color: transparent;
        }

        html {
            /* Prevent pull-to-refresh on iOS */
            overscroll-behavior-y: contain;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            transition: all 0.3s ease;
            /* iOS safe areas */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            /* Prevent text size adjustment on orientation change */
            -webkit-text-size-adjust: 100%;
            /* Smooth scrolling */
            -webkit-overflow-scrolling: touch;
        }

        /* Fix iOS 100vh issue */
        @supports (-webkit-touch-callout: none) {
            body {
                min-height: -webkit-fill-available;
            }
        }

        /* Top Bar */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: calc(56px + env(safe-area-inset-top));
            padding-top: env(safe-area-inset-top);
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            box-shadow: 0 2px 10px var(--shadow);
            z-index: 100;
        }

        .top-bar-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
            text-align: center;
            margin: 0;
        }

        /* Hamburger Menu */
        .hamburger {
            width: 44px;
            height: 44px;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
            flex-shrink: 0;
            margin: 6px;
        }

        .hamburger:hover {
            opacity: 0.7;
        }

        .hamburger span {
            display: block;
            width: 20px;
            height: 2px;
            background: var(--text-primary);
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(5px, -5px);
        }

        /* Sidebar Menu */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            z-index: 998;
            transition: all 0.3s ease;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background: var(--bg-secondary);
            z-index: 999;
            transition: all 0.3s ease;
            box-shadow: 4px 0 20px var(--shadow);
            display: flex;
            flex-direction: column;
        }

        .sidebar.active {
            left: 0;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-logo {
            font-size: 1.4rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sidebar-nav {
            padding: 1rem 0;
            flex: 1;
        }

        .sidebar-version {
            padding: 1rem 1.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            opacity: 0.5;
            border-top: 1px solid var(--border);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-family: inherit;
            font-size: 1rem;
        }

        .nav-item:hover {
            background: rgba(230, 57, 70, 0.08);
            color: var(--accent);
        }

        .nav-item:active {
            background: rgba(230, 57, 70, 0.15);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(230, 57, 70, 0.15) 0%, rgba(255, 107, 122, 0.1) 100%);
            color: var(--accent);
            border-right: 3px solid var(--accent);
        }

        .nav-item-icon {
            font-size: 1.3rem;
            width: 28px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            padding: calc(5rem + env(safe-area-inset-top)) 1.5rem calc(1.5rem + env(safe-area-inset-bottom));
            padding-left: calc(1.5rem + env(safe-area-inset-left));
            padding-right: calc(1.5rem + env(safe-area-inset-right));
            max-width: 900px;
            margin: 0 auto;
        }

        .page {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .page.active {
            display: block;
        }

        header {
            text-align: center;
            margin-bottom: 2.5rem;
            animation: fadeInDown 0.6s ease-out;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-size: clamp(1.8rem, 5vw, 2.5rem);
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .upload-zone {
            display: block;
            background: var(--bg-secondary);
            border: 2px dashed var(--border);
            border-radius: 20px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: fadeIn 0.6s ease-out 0.2s both;
            position: relative;
            overflow: hidden;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .upload-zone:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 10px 40px var(--shadow);
        }

        .upload-zone.dragover {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(230, 57, 70, 0.05) 0%, rgba(255, 107, 122, 0.05) 100%);
        }

        .upload-zone.has-file {
            border-style: solid;
            border-color: var(--success);
        }

        .upload-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .upload-text {
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .upload-hint {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .file-name {
            font-family: 'Space Mono', monospace;
            background: var(--bg-accent);
            color: var(--bg-primary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            display: inline-block;
            margin-top: 1rem;
            font-size: 0.85rem;
        }

        .dark .file-name {
            background: var(--accent);
            color: #fff;
        }

        #fileInput {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1.5rem;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            /* iOS touch improvements */
            -webkit-appearance: none;
            touch-action: manipulation;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(230, 57, 70, 0.3);
        }

        /* iOS active state for touch feedback */
        .btn:active:not(:disabled) {
            transform: scale(0.97);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading-section {
            display: none;
            text-align: center;
            padding: 3rem;
            animation: fadeIn 0.4s ease-out;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .schedule-section {
            display: none;
            margin-top: 2rem;
            animation: fadeIn 0.6s ease-out;
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .schedule-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .time-badge {
            font-family: 'Space Mono', monospace;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            color: white;
            padding: 0.3rem 0.7rem;
            border-radius: 6px;
            font-size: 0.85rem;
            display: inline-block;
        }

        .error-message {
            background: rgba(230, 57, 70, 0.1);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin-top: 1.5rem;
            display: none;
        }

        .reset-btn {
            background: transparent;
            border: 2px solid var(--border);
            color: var(--text-primary);
            padding: 0.7rem 1.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .reset-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .person-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px var(--shadow);
            margin-bottom: 1.5rem;
            animation: fadeIn 0.5s ease-out forwards;
            opacity: 0;
        }

        .person-name {
            background: var(--bg-accent);
            color: var(--bg-primary);
            padding: 1rem 1.25rem;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dark .person-name {
            background: var(--accent);
            color: #fff;
        }

        .person-name::before {
            content: 'ðŸ‘¤';
        }

        .person-schedule {
            width: 100%;
        }

        .person-schedule table {
            width: 100%;
            border-collapse: collapse;
        }

        .person-schedule th {
            background: rgba(230, 57, 70, 0.08);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .dark .person-schedule th {
            background: rgba(255, 107, 122, 0.15);
        }

        .person-schedule {
            max-height: 400px;
            overflow-y: auto;
        }

        .person-schedule td {
            padding: 0.85rem 1rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.95rem;
        }

        .person-schedule tr:last-child td {
            border-bottom: none;
        }

        .person-schedule tr:hover td {
            background: rgba(230, 57, 70, 0.03);
        }

        .weekday-cell {
            font-weight: 500;
            white-space: nowrap;
        }

        .date-cell {
            font-family: 'Space Mono', monospace;
            white-space: nowrap;
            text-align: center;
            min-width: 70px;
        }

        .service-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .service-badge {
            background: rgba(42, 157, 143, 0.15);
            color: var(--success);
            padding: 0.3rem 0.7rem;
            border-radius: 6px;
            font-size: 0.85rem;
            display: inline-block;
            font-weight: 600;
            font-family: 'Space Mono', monospace;
            min-width: 40px;
            text-align: center;
        }

        .service-free {
            background: rgba(100, 100, 120, 0.15);
            color: var(--text-secondary);
            padding: 0.3rem 0.7rem;
            border-radius: 6px;
            font-size: 0.85rem;
            display: inline-block;
            font-weight: 500;
            font-style: italic;
            min-width: 40px;
            text-align: center;
        }

        .service-icon {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 700;
            text-align: center;
            line-height: 1.1;
            flex-shrink: 0;
            overflow: hidden;
        }

        .service-icon.flag-sweden {
            background: linear-gradient(180deg, #006AA7 0%, #006AA7 40%, #FECC00 40%, #FECC00 60%, #006AA7 60%, #006AA7 100%);
            position: relative;
        }

        .service-icon.flag-sweden::before {
            content: '';
            position: absolute;
            left: 25%;
            top: 0;
            width: 20%;
            height: 100%;
            background: #FECC00;
        }

        .service-icon.flag-denmark {
            background: #C8102E;
            position: relative;
        }

        .service-icon.flag-denmark::before {
            content: '';
            position: absolute;
            left: 25%;
            top: 0;
            width: 15%;
            height: 100%;
            background: #fff;
        }

        .service-icon.flag-denmark::after {
            content: '';
            position: absolute;
            left: 0;
            top: 42%;
            width: 100%;
            height: 16%;
            background: #fff;
        }

        .service-icon.icon-text {
            background: #ffffff;
            color: #1a1a1a;
            padding: 3px 4px;
            border: 2px solid #1a1a1a;
            font-weight: 600;
        }

        .dark .service-icon.icon-text {
            background: #ffffff;
            color: #1a1a1a;
            border-color: #1a1a1a;
        }

        .service-icon.icon-dag1 {
            background: #ffffff;
            color: #1a1a1a;
            padding: 3px 4px;
            border: 2px solid #1a1a1a;
            border-bottom: none;
            font-weight: 600;
            position: relative;
            clip-path: polygon(0 0, 100% 0, 100% 85%, 90% 90%, 80% 85%, 70% 95%, 60% 85%, 50% 92%, 40% 85%, 30% 90%, 20% 85%, 10% 92%, 0 85%);
            padding-bottom: 8px;
        }

        .service-icon.icon-dag2 {
            background: #ffffff;
            color: #1a1a1a;
            padding: 3px 4px;
            border: 2px solid #1a1a1a;
            border-top: none;
            font-weight: 600;
            position: relative;
            clip-path: polygon(0 15%, 10% 8%, 20% 15%, 30% 5%, 40% 15%, 50% 10%, 60% 15%, 70% 5%, 80% 15%, 90% 8%, 100% 15%, 100% 100%, 0 100%);
            padding-top: 8px;
        }

        .dark .service-icon.icon-dag1,
        .dark .service-icon.icon-dag2 {
            background: #ffffff;
            color: #1a1a1a;
        }

        .no-schedule {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 3rem;
            text-align: center;
            color: var(--text-secondary);
            box-shadow: 0 4px 20px var(--shadow);
        }

        /* Today's Workers Page */
        .today-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .date-nav-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .date-nav-btn {
            width: 44px;
            height: 44px;
            border: none;
            background: var(--bg-secondary);
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--text-primary);
            box-shadow: 0 4px 15px var(--shadow);
            transition: all 0.2s ease;
        }

        .date-nav-btn:hover {
            background: var(--accent);
            color: white;
            transform: scale(1.05);
        }

        .date-nav-btn:active {
            transform: scale(0.98);
        }

        .date-display-picker {
            background: var(--bg-secondary);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px var(--shadow);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            min-width: 220px;
        }

        .date-display-picker:hover {
            box-shadow: 0 6px 20px var(--shadow);
            transform: translateY(-2px);
        }

        .date-display-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .date-display-text::after {
            content: 'ðŸ“…';
            font-size: 1rem;
        }

        .hidden-date-picker {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            cursor: pointer;
            z-index: 2;
            font-size: 16px;
        }

        /* Show picker on focus for better mobile support */
        .hidden-date-picker::-webkit-calendar-picker-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: auto;
            height: auto;
            color: transparent;
            background: transparent;
            cursor: pointer;
        }

        .worker-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 2px 8px var(--shadow);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: fadeIn 0.3s ease-out forwards;
            opacity: 0;
            /* iOS touch improvements */
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .worker-card.clickable:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .worker-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }

        .worker-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 0;
        }

        .worker-name {
            font-weight: 600;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .worker-time {
            color: var(--text-secondary);
            font-size: 0.85rem;
            white-space: nowrap;
            font-family: 'Space Mono', monospace;
        }

        .worker-service {
            text-align: right;
            flex-shrink: 0;
        }

        .no-data-message {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 3rem 2rem;
            text-align: center;
            box-shadow: 0 4px 15px var(--shadow);
        }

        .no-data-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .no-data-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .no-data-text {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .link-btn {
            background: transparent;
            border: 2px solid var(--accent);
            color: var(--accent);
            padding: 0.75rem 1.5rem;
            font-size: 0.95rem;
            font-weight: 500;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .link-btn:hover {
            background: var(--accent);
            color: white;
        }

        /* Upload Tabs */
        .upload-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            background: var(--bg-secondary);
            padding: 0.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .upload-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upload-tab:hover {
            color: var(--text-primary);
            background: rgba(230, 57, 70, 0.05);
        }

        .upload-tab.active {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            color: white;
        }

        .schedule-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .save-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 0.7rem 1.25rem;
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(42, 157, 143, 0.3);
        }

        .filter-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
            gap: 0.5rem;
            background: var(--bg-secondary);
            padding: 0.6rem 1rem;
            border-radius: 10px;
        }

        .include-free-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            user-select: none;
            font-size: 0.9rem;
            color: var(--text-secondary);
            transition: color 0.2s ease;
        }

        .include-free-checkbox:hover {
            color: var(--text-primary);
        }

        .include-free-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        .reset-btn.danger {
            border-color: var(--accent);
            color: var(--accent);
        }

        .reset-btn.danger:hover {
            background: var(--accent);
            color: white;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 1rem;
            animation: fadeIn 0.2s ease-out;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-bottom: 1px solid var(--border);
        }

        .dark .modal-header {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-title::before {
            content: 'ðŸ‘¤';
        }

        .modal-close {
            background: var(--border);
            border: none;
            color: var(--text-primary);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--text-secondary);
            color: var(--bg-primary);
            transform: scale(1.1);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .modal-schedule-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        /* Column widths: Veckodag, Datum, Tid, TjÃ¤nst */
        .modal-schedule-table th:nth-child(1),
        .modal-schedule-table td:nth-child(1) { width: 18%; }
        .modal-schedule-table th:nth-child(2),
        .modal-schedule-table td:nth-child(2) { width: 22%; }
        .modal-schedule-table th:nth-child(3),
        .modal-schedule-table td:nth-child(3) { width: 28%; }
        .modal-schedule-table th:nth-child(4),
        .modal-schedule-table td:nth-child(4) { width: 32%; }

        .modal-schedule-table th {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 0.5rem 0.4rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            white-space: nowrap;
        }

        .dark .modal-schedule-table th {
            background: var(--bg-secondary);
        }

        .schedule-table-header {
            flex-shrink: 0;
        }

        .modal-schedule-table td {
            padding: 0.5rem 0.4rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .modal-schedule-table tr:hover td {
            background: var(--bg-primary);
        }

        /* Clickable worker card */
        .worker-card.clickable {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .worker-card.clickable:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 25px var(--shadow);
        }

        .worker-card.clickable:active {
            transform: translateX(2px);
        }

        .person-count {
            font-size: 0.9rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .person-count strong {
            color: var(--accent);
        }

        .worker-card.free-day {
            border: 2px solid var(--success);
        }

        /* Schedules List */
        .schedule-list-item {
            background: var(--bg-secondary);
            border-radius: 16px;
            margin-bottom: 1rem;
            overflow: hidden;
            box-shadow: 0 4px 15px var(--shadow);
        }

        .schedule-list-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            /* iOS touch improvements */
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .schedule-list-header:hover {
            background: rgba(230, 57, 70, 0.05);
        }

        .schedule-list-header:active {
            transform: scale(0.99);
        }

        .schedule-list-table {
            width: 100%;
            border-collapse: collapse;
        }

        .schedule-list-table th {
            background: var(--bg-primary);
            color: var(--text-secondary);
            padding: 0.6rem 0.75rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .schedule-list-table td {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        .schedule-list-table tr:last-child td {
            border-bottom: none;
        }

        .editable-cell {
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            transition: background 0.2s ease;
            display: inline-block;
            min-width: 60px;
        }

        .editable-cell:hover {
            background: rgba(230, 57, 70, 0.1);
        }

        .editable-cell input {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border: 2px solid var(--accent);
            border-radius: 6px;
            font-size: 0.9rem;
            font-family: inherit;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .editable-cell input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.2);
        }

        .schedule-list-name {
            font-weight: 600;
            font-size: 1.05rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .schedule-list-name::before {
            content: 'ðŸ‘¤';
        }

        .schedule-list-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .schedule-list-actions {
            display: flex;
            gap: 0.5rem;
        }

        .schedule-list-btn {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.4rem 0.75rem;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .schedule-list-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
            color: var(--accent);
        }

        .schedule-list-btn.delete {
            border-color: var(--border);
        }

        .schedule-list-btn.delete:hover {
            background: rgba(230, 57, 70, 0.1);
            border-color: var(--accent);
            color: var(--accent);
        }

        .toggle-icon {
            transition: transform 0.3s ease;
        }

        .schedule-list-item.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .schedule-list-body {
            display: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .schedule-list-item.expanded .schedule-list-body {
            display: block;
        }

        .schedules-summary {
            background: var(--bg-secondary);
            padding: 1rem 1.25rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            box-shadow: 0 4px 15px var(--shadow);
        }

        .schedules-summary-compact {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding: 0 0.25rem;
        }

        .schedules-count {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .clear-btn-small {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.4rem 0.75rem;
            font-size: 0.8rem;
            font-family: inherit;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clear-btn-small:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .clear-btn-small:active {
            transform: scale(0.97);
        }

        .schedules-summary-text {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .schedules-summary-text strong {
            color: var(--accent);
        }

        /* Upload Success */
        .upload-success {
            text-align: center;
            padding: 3rem 2rem;
            background: var(--bg-secondary);
            border-radius: 20px;
            box-shadow: 0 4px 20px var(--shadow);
            animation: fadeIn 0.4s ease-out;
        }

        .success-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .success-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--success);
            margin-bottom: 0.5rem;
        }

        .success-text {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        /* Form styles */
        .add-person-section,
        .add-entry-section,
        .import-section {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 15px var(--shadow);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        /* Month selector */
        .month-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            -webkit-overflow-scrolling: touch;
        }

        .month-selector::-webkit-scrollbar {
            height: 4px;
        }

        .month-selector::-webkit-scrollbar-track {
            background: var(--border);
            border-radius: 2px;
        }

        .month-selector::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 2px;
        }

        .month-btn {
            flex-shrink: 0;
            padding: 0.6rem 1rem;
            border: 2px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 500;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .month-btn:hover {
            border-color: var(--text-primary);
            color: var(--text-primary);
        }

        .month-btn.active {
            background: var(--bg-accent);
            border-color: transparent;
            color: var(--bg-primary);
        }

        .dark .month-btn.active {
            background: var(--text-primary);
            color: var(--bg-primary);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: border-color 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-row {
            display: flex;
            gap: 1rem;
        }

        .form-group.half {
            flex: 1;
        }

        .import-section .upload-zone {
            margin: 0;
            animation: none;
        }

        @media (max-width: 600px) {
            .main-content {
                padding: 4.5rem 1rem 1rem;
            }

            .upload-zone {
                padding: 2rem 1.5rem;
            }

            .upload-icon {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .worker-card {
                flex-wrap: nowrap;
            }

            .worker-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.2rem;
            }

            .worker-name {
                font-size: 0.9rem;
            }

            .worker-time {
                font-size: 0.8rem;
            }
        }

        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 1.5rem;
            padding-top: calc(1.5rem + env(safe-area-inset-top));
            padding-bottom: calc(1.5rem + env(safe-area-inset-bottom));
        }

        .login-container {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 2.5rem 2rem;
            max-width: 320px;
            width: 100%;
            box-shadow: 0 20px 60px var(--shadow);
            animation: fadeIn 0.5s ease-out;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .login-logo-text {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .login-input-group {
            position: relative;
        }

        .login-input {
            width: 100%;
            padding: 0.9rem 1rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.2s ease;
            text-align: center;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(230, 57, 70, 0.1);
        }

        .login-input::placeholder {
            color: var(--text-secondary);
        }

        .login-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.9rem;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            margin-top: 0.25rem;
        }

        .login-btn:hover {
            opacity: 0.9;
        }

        .login-btn:active {
            transform: scale(0.98);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .login-error {
            background: rgba(230, 57, 70, 0.1);
            color: var(--accent);
            padding: 0.6rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            text-align: center;
            display: none;
            animation: shake 0.4s ease;
        }

        .login-error.show {
            display: block;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        /* Password Setup */
        .setup-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 1rem;
        }

        .version-text {
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-secondary);
            opacity: 0.6;
            margin-top: 1.5rem;
        }

        .hidden {
            display: none !important;
        }

        /* Sync indicator */
        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.5rem;
            margin-right: 0.5rem;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .sync-indicator.online {
            color: var(--success);
        }

        .sync-indicator.offline {
            color: var(--accent);
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .sync-icon {
            font-size: 1rem;
            opacity: 0.7;
        }

        .sync-indicator.syncing .sync-dot {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-logo">
                <div class="login-logo-text">Schema</div>
            </div>

            <!-- Login Form -->
            <div id="loginForm" class="login-form">
                <div class="login-input-group">
                    <input type="password" id="loginPassword" class="login-input" placeholder="LÃ¶senord" autocomplete="current-password">
                </div>
                <div class="login-error" id="loginError">Fel lÃ¶senord. FÃ¶rsÃ¶k igen.</div>
                <button type="button" class="login-btn" onclick="attemptLogin()">Logga in</button>
            </div>

            <!-- Setup Form (first time) -->
            <div id="setupForm" class="login-form hidden">
                <div class="setup-subtitle">Skapa ett lÃ¶senord</div>
                <div class="login-input-group">
                    <input type="password" id="setupPassword" class="login-input" placeholder="VÃ¤lj lÃ¶senord" autocomplete="new-password">
                </div>
                <div class="login-input-group">
                    <input type="password" id="setupPasswordConfirm" class="login-input" placeholder="BekrÃ¤fta lÃ¶senord" autocomplete="new-password">
                </div>
                <div class="login-error" id="setupError">LÃ¶senorden matchar inte.</div>
                <button type="button" class="login-btn" onclick="createPassword()">Skapa</button>
            </div>

            <div class="version-text">Version 0.16</div>
        </div>
    </div>

    <!-- Top Bar -->
    <div class="top-bar">
        <button class="hamburger" id="hamburgerBtn">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <h1 class="top-bar-title" id="topBarTitle">Vem jobbar idag?</h1>
        <div class="sync-indicator online" id="syncIndicator">
            <span class="sync-dot"></span>
            <span class="sync-icon">â˜ï¸</span>
        </div>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                ðŸ“… Schemahanterare
            </div>
        </div>
        <div class="sidebar-nav">
            <button class="nav-item active" data-page="today">
                <span class="nav-item-icon">ðŸ‘¥</span>
                Vem jobbar idag
            </button>
            <button class="nav-item" data-page="schedules">
                <span class="nav-item-icon">ðŸ“‹</span>
                Scheman
            </button>
            <button class="nav-item" data-page="upload">
                <span class="nav-item-icon">ðŸ“¤</span>
                Ladda upp schema
            </button>
        </div>
        <div class="sidebar-version">Version 0.16</div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Today's Workers Page -->
        <div class="page active" id="page-today">
            <div class="date-nav-container">
                <button class="date-nav-btn" id="prevDayBtn" title="FÃ¶regÃ¥ende dag">â†</button>
                <div class="date-display-picker">
                    <div class="date-display-text" id="dateDisplayText"></div>
                    <input type="date" id="datePicker" class="hidden-date-picker">
                </div>
                <button class="date-nav-btn" id="nextDayBtn" title="NÃ¤sta dag">â†’</button>
            </div>

            <div id="todayWorkersList">
                <div class="no-data-message">
                    <div class="no-data-icon">ðŸ“‹</div>
                    <div class="no-data-title">Inget schema laddat</div>
                    <div class="no-data-text">Ladda upp ett schema fÃ¶r att se vem som jobbar idag</div>
                    <button class="link-btn" id="goToUploadBtn">Ladda upp schema</button>
                </div>
            </div>
        </div>

        <!-- Schedules Page -->
        <div class="page" id="page-schedules">
            <div id="schedulesListContainer">
                <div class="no-data-message">
                    <div class="no-data-icon">ðŸ“‹</div>
                    <div class="no-data-title">Inga scheman</div>
                    <div class="no-data-text">Ladda upp scheman fÃ¶r att se dem hÃ¤r</div>
                    <button class="link-btn" id="goToUploadBtn2">Ladda upp schema</button>
                </div>
            </div>
        </div>

        <!-- Upload Schedule Page -->
        <div class="page" id="page-upload">
            <!-- Import Section -->
            <div class="import-section">
                <label class="upload-zone" id="uploadZone" for="fileInput">
                    <div class="upload-icon">ðŸ“„</div>
                    <p class="upload-text">Tryck hÃ¤r fÃ¶r att vÃ¤lja fil</p>
                    <p class="upload-hint">PDF eller JSON-fil</p>
                    <div class="file-name" id="fileName" style="display: none;"></div>
                    <input type="file" id="fileInput" accept=".pdf,.json">
                </label>
            </div>

            <div class="error-message" id="errorMessage"></div>

            <div class="loading-section" id="loadingSection" style="display: none;">
                <div class="spinner"></div>
                <p class="loading-text" id="loadingText">LÃ¤ser PDF...</p>
            </div>

            <div class="upload-success" id="uploadSuccess" style="display: none;">
                <div class="success-icon">âœ…</div>
                <h2 class="success-title">Klar!</h2>
                <p class="success-text" id="successText">Schemat har sparats</p>
                <button class="btn" id="uploadNewBtn">
                    <span>ðŸ“„</span> LÃ¤gg till fler
                </button>
            </div>
        </div>
    </div>

    <!-- Person Detail Modal -->
    <div class="modal-overlay" id="personModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalPersonName">Personnamn</h2>
                <button class="modal-close" id="modalClose">âœ•</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Person schedule will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // ============================================
        // APP VERSION
        const APP_VERSION = '0.16';

        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyBM98KCQiC5bPx0hp83OnUP-CCAjpvObZI",
            authDomain: "schema-2026.firebaseapp.com",
            databaseURL: "https://schema-2026-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "schema-2026",
            storageBucket: "schema-2026.firebasestorage.app",
            messagingSenderId: "822533325776",
            appId: "1:822533325776:web:35e8be2c5855388ca7efd5",
            measurementId: "G-G8GN6X7W9Q"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const schedulesRef = database.ref('schedules');
        const passwordRef = database.ref('appPassword');

        // ============================================
        // SECURE PASSWORD SYSTEM (Firebase + SHA-256)
        // ============================================
        const storage = window['local' + 'Storage'];
        const SESSION_KEY = 'schema_session';

        // SHA-256 hash using Web Crypto API
        async function sha256Hash(str) {
            const encoder = new TextEncoder();
            const data = encoder.encode(str);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Get stored password hash from Firebase (with timeout)
        async function getStoredPasswordHash() {
            return new Promise((resolve) => {
                // Timeout after 5 seconds
                const timeout = setTimeout(() => {
                    console.log('Firebase timeout - no password found');
                    resolve(null);
                }, 5000);

                passwordRef.once('value').then((snapshot) => {
                    clearTimeout(timeout);
                    resolve(snapshot.val());
                }).catch((err) => {
                    clearTimeout(timeout);
                    console.log('Firebase password error:', err);
                    resolve(null);
                });
            });
        }

        // Save password hash to Firebase
        async function savePasswordHash(hash) {
            return passwordRef.set(hash);
        }

        // ============================================
        // IndexedDB for persistent device-specific session
        // ============================================
        const DB_NAME = 'SchemaApp';
        const STORE_NAME = 'session';

        function openSessionDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };
            });
        }

        async function isLoggedInDB() {
            try {
                const db = await openSessionDB();
                return new Promise((resolve) => {
                    const tx = db.transaction(STORE_NAME, 'readonly');
                    const store = tx.objectStore(STORE_NAME);
                    const request = store.get('loggedIn');
                    request.onsuccess = () => resolve(request.result === true);
                    request.onerror = () => resolve(false);
                });
            } catch (e) {
                console.log('IndexedDB read error:', e);
                return false;
            }
        }

        async function setLoggedInDB(value) {
            try {
                const db = await openSessionDB();
                return new Promise((resolve) => {
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    if (value) {
                        store.put(true, 'loggedIn');
                    } else {
                        store.delete('loggedIn');
                    }
                    tx.oncomplete = () => resolve(true);
                    tx.onerror = () => resolve(false);
                });
            } catch (e) {
                console.log('IndexedDB write error:', e);
                return false;
            }
        }

        // Try localStorage as fallback
        function isLoggedInLocal() {
            try {
                if (storage) {
                    return storage.getItem(SESSION_KEY) === 'active';
                }
            } catch (e) {
                console.log('localStorage read error:', e);
            }
            return false;
        }

        function setLoggedInLocal(value) {
            try {
                if (storage) {
                    if (value) {
                        storage.setItem(SESSION_KEY, 'active');
                    } else {
                        storage.removeItem(SESSION_KEY);
                    }
                }
            } catch (e) {
                console.log('localStorage write error:', e);
            }
        }

        // Combined session check (IndexedDB + localStorage)
        async function isLoggedIn() {
            // Try IndexedDB first (more persistent)
            const dbLoggedIn = await isLoggedInDB();
            if (dbLoggedIn) return true;

            // Fallback to localStorage
            return isLoggedInLocal();
        }

        // Save session to both storages
        async function setLoggedIn(value) {
            await setLoggedInDB(value);
            setLoggedInLocal(value);
        }

        async function initAuth() {
            const loginScreen = document.getElementById('loginScreen');
            const loginForm = document.getElementById('loginForm');
            const setupForm = document.getElementById('setupForm');

            // Check if already logged in on this device
            const loggedIn = await isLoggedIn();
            if (loggedIn) {
                loginScreen.classList.add('hidden');
                return;
            }

            // Show loading state
            const loginBtn = document.querySelector('#loginForm .login-btn');
            if (loginBtn) loginBtn.textContent = 'Ansluter...';

            // Check if password exists in Firebase
            const storedHash = await getStoredPasswordHash();

            if (loginBtn) loginBtn.textContent = 'Logga in';

            if (storedHash) {
                // Show login form
                loginForm.classList.remove('hidden');
                setupForm.classList.add('hidden');
            } else {
                // Show setup form (first time)
                loginForm.classList.add('hidden');
                setupForm.classList.remove('hidden');
            }
        }

        async function attemptLogin() {
            const password = document.getElementById('loginPassword').value;
            const loginError = document.getElementById('loginError');
            const loginBtn = document.querySelector('#loginForm .login-btn');

            if (!password) {
                loginError.textContent = 'Ange ett lÃ¶senord.';
                loginError.classList.add('show');
                return;
            }

            // Show loading state
            loginBtn.textContent = 'Loggar in...';
            loginBtn.disabled = true;

            try {
                const storedHash = await getStoredPasswordHash();
                const inputHash = await sha256Hash(password);

                // If no stored hash found, show error about connection
                if (!storedHash) {
                    loginError.textContent = 'Kunde inte ansluta till databasen. FÃ¶rsÃ¶k igen.';
                    loginError.classList.add('show');
                    return;
                }

                if (inputHash === storedHash) {
                    // Success - save session to device
                    await setLoggedIn(true);
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('loginPassword').value = '';
                    loginError.classList.remove('show');
                } else {
                    // Wrong password
                    loginError.textContent = 'Fel lÃ¶senord. FÃ¶rsÃ¶k igen.';
                    loginError.classList.add('show');
                    document.getElementById('loginPassword').value = '';
                    document.getElementById('loginPassword').focus();
                }
            } catch (e) {
                console.log('Login error:', e);
                loginError.textContent = 'Ett fel uppstod: ' + (e.message || 'OkÃ¤nt fel');
                loginError.classList.add('show');
            } finally {
                loginBtn.textContent = 'Logga in';
                loginBtn.disabled = false;
            }
        }

        async function createPassword() {
            const password = document.getElementById('setupPassword').value;
            const confirmPassword = document.getElementById('setupPasswordConfirm').value;
            const setupError = document.getElementById('setupError');
            const setupBtn = document.querySelector('#setupForm .login-btn');

            if (!password) {
                setupError.textContent = 'Ange ett lÃ¶senord.';
                setupError.classList.add('show');
                return;
            }

            if (password.length < 4) {
                setupError.textContent = 'LÃ¶senordet mÃ¥ste vara minst 4 tecken.';
                setupError.classList.add('show');
                return;
            }

            if (password !== confirmPassword) {
                setupError.textContent = 'LÃ¶senorden matchar inte.';
                setupError.classList.add('show');
                return;
            }

            // Show loading state
            setupBtn.textContent = 'Skapar...';
            setupBtn.disabled = true;

            try {
                // Save password hash to Firebase
                const hash = await sha256Hash(password);
                await savePasswordHash(hash);

                // Save session to device
                await setLoggedIn(true);

                // Hide login screen
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('setupPassword').value = '';
                document.getElementById('setupPasswordConfirm').value = '';
                setupError.classList.remove('show');

                showToast('LÃ¶senord skapat!');
            } catch (e) {
                console.log('Create password error:', e);
                // Show more specific error message
                if (e.code === 'PERMISSION_DENIED') {
                    setupError.textContent = 'DatabasÃ¥tkomst nekad. Kontrollera Firebase-regler.';
                } else {
                    setupError.textContent = 'Kunde inte spara: ' + (e.message || 'OkÃ¤nt fel');
                }
                setupError.classList.add('show');
            } finally {
                setupBtn.textContent = 'Skapa';
                setupBtn.disabled = false;
            }
        }

        // Handle Enter key on password fields
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    attemptLogin();
                }
            });

            document.getElementById('setupPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('setupPasswordConfirm').focus();
                }
            });

            document.getElementById('setupPasswordConfirm').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    createPassword();
                }
            });

            // Set version numbers dynamically
            document.querySelectorAll('.version-text, .sidebar-version').forEach(el => {
                el.textContent = 'Version ' + APP_VERSION;
            });
        });

        // Initialize auth on page load
        initAuth();

        // Elements
        const hamburgerBtn = document.getElementById('hamburgerBtn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const navItems = document.querySelectorAll('.nav-item');
        const pages = document.querySelectorAll('.page');

        // PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('fileName');
        const errorMessage = document.getElementById('errorMessage');
        const loadingSection = document.getElementById('loadingSection');
        const loadingText = document.getElementById('loadingText');
        const goToUploadBtn = document.getElementById('goToUploadBtn');
        const todayWorkersList = document.getElementById('todayWorkersList');
        const datePicker = document.getElementById('datePicker');
        const dateDisplayText = document.getElementById('dateDisplayText');
        const prevDayBtn = document.getElementById('prevDayBtn');
        const nextDayBtn = document.getElementById('nextDayBtn');

        // New elements
        const uploadSuccess = document.getElementById('uploadSuccess');
        const successText = document.getElementById('successText');
        const uploadNewBtn = document.getElementById('uploadNewBtn');
        const personModal = document.getElementById('personModal');
        const modalPersonName = document.getElementById('modalPersonName');
        const modalBody = document.getElementById('modalBody');
        const modalClose = document.getElementById('modalClose');

        let selectedFile = null;
        let scheduleData = null;

        let selectedDate = new Date();
        let includeFree = false;

        // Set today's date in date picker
        function initDatePicker() {
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            datePicker.value = dateStr;
            updateDateDisplay(now);
        }

        function updateDateDisplay(date) {
            const weekdays = ['SÃ¶n', 'MÃ¥n', 'Tis', 'Ons', 'Tor', 'Fre', 'LÃ¶r'];
            const months = ['jan', 'feb', 'mar', 'apr', 'maj', 'jun', 'jul', 'aug', 'sep', 'okt', 'nov', 'dec'];
            const weekday = weekdays[date.getDay()];
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear();

            dateDisplayText.textContent = `${weekday} ${day} ${month} ${year}`;
        }

        datePicker.addEventListener('change', (e) => {
            selectedDate = new Date(e.target.value);
            updateDateDisplay(selectedDate);
            renderTodayWorkers();
        });

        // Arrow navigation
        prevDayBtn.addEventListener('click', () => {
            selectedDate.setDate(selectedDate.getDate() - 1);
            datePicker.value = selectedDate.toISOString().split('T')[0];
            updateDateDisplay(selectedDate);
            renderTodayWorkers();
        });

        nextDayBtn.addEventListener('click', () => {
            selectedDate.setDate(selectedDate.getDate() + 1);
            datePicker.value = selectedDate.toISOString().split('T')[0];
            updateDateDisplay(selectedDate);
            renderTodayWorkers();
        });

        // Click on date display to open picker
        const dateDisplayPicker = document.querySelector('.date-display-picker');
        dateDisplayPicker.addEventListener('click', (e) => {
            // Prevent double triggering if clicking on the input itself
            if (e.target !== datePicker) {
                // Try showPicker first, fall back to focus+click
                try {
                    datePicker.showPicker();
                } catch (err) {
                    datePicker.focus();
                    datePicker.click();
                }
            }
        });

        initDatePicker();

        // Hamburger menu toggle
        function toggleSidebar() {
            hamburgerBtn.classList.toggle('active');
            sidebar.classList.toggle('active');
            sidebarOverlay.classList.toggle('active');
        }

        hamburgerBtn.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);

        // Page titles for top bar
        const pageTitles = {
            'today': 'Vem jobbar idag?',
            'schedules': 'Scheman',
            'upload': 'Importera schema'
        };

        // Navigation
        function navigateTo(pageId) {
            navItems.forEach(item => {
                item.classList.toggle('active', item.dataset.page === pageId);
            });
            pages.forEach(page => {
                page.classList.toggle('active', page.id === `page-${pageId}`);
            });

            // Update top bar title
            const topBarTitle = document.getElementById('topBarTitle');
            if (topBarTitle && pageTitles[pageId]) {
                topBarTitle.textContent = pageTitles[pageId];
            }

            if (pageId === 'today') {
                renderTodayWorkers();
            } else if (pageId === 'schedules') {
                renderSchedulesList();
            }

            // Close sidebar on mobile
            if (sidebar.classList.contains('active')) {
                toggleSidebar();
            }
        }

        navItems.forEach(item => {
            item.addEventListener('click', () => navigateTo(item.dataset.page));
        });

        goToUploadBtn.addEventListener('click', () => navigateTo('upload'));
        document.getElementById('goToUploadBtn2').addEventListener('click', () => navigateTo('upload'));

        // Upload new button
        uploadNewBtn.addEventListener('click', () => {
            resetUploadPage();
        });

        function resetUploadPage() {
            selectedFile = null;
            fileInput.value = '';
            fileNameDisplay.style.display = 'none';
            uploadZone.classList.remove('has-file');
            uploadSuccess.style.display = 'none';
            document.querySelector('.import-section').style.display = 'block';
            hideError();
        }

        // Modal functions
        modalClose.addEventListener('click', closeModal);
        personModal.addEventListener('click', (e) => {
            if (e.target === personModal) closeModal();
        });

        // Handle file import (PDF or JSON)
        function handleFile(file) {
            if (!file) {
                showError('Ingen fil vald.');
                return;
            }

            selectedFile = file;
            fileNameDisplay.textContent = file.name;
            fileNameDisplay.style.display = 'inline-block';
            uploadZone.classList.add('has-file');
            hideError();

            // Check file type
            if (file.name.toLowerCase().endsWith('.pdf')) {
                importPdfFile(file);
            } else {
                importJsonFile(file);
            }
        }

        async function importJsonFile(file) {
            try {
                const text = await file.text();
                const data = JSON.parse(text);

                if (!data.people || !Array.isArray(data.people)) {
                    throw new Error('Ogiltig schema-fil. Saknar "people"-data.');
                }

                // Merge with existing data
                if (scheduleData && scheduleData.people && scheduleData.people.length > 0) {
                    mergeScheduleData(data);
                } else {
                    scheduleData = data;
                }

                saveToLocalStorage();
                showUploadSuccess(data.people.length);
            } catch (err) {
                showError('Kunde inte lÃ¤sa filen: ' + err.message);
            }
        }

        async function importPdfFile(file) {
            try {
                document.querySelector('.import-section').style.display = 'none';
                loadingSection.style.display = 'block';
                loadingText.textContent = 'LÃ¤ser PDF...';

                // Extract text from PDF
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = '';

                for (let i = 1; i <= pdf.numPages; i++) {
                    loadingText.textContent = `LÃ¤ser sida ${i} av ${pdf.numPages}...`;
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }

                loadingText.textContent = 'Analyserar schema...';

                // Parse the text to extract schedule data
                const extractedData = parseScheduleFromText(fullText);

                if (!extractedData.people || extractedData.people.length === 0) {
                    loadingSection.style.display = 'none';
                    document.querySelector('.import-section').style.display = 'block';
                    showError('Kunde inte hitta nÃ¥got schema i PDF:en. Kontrollera att filen Ã¤r korrekt.');
                    return;
                }

                // Merge with existing data
                if (scheduleData && scheduleData.people && scheduleData.people.length > 0) {
                    mergeScheduleData(extractedData);
                } else {
                    scheduleData = extractedData;
                }

                saveToLocalStorage();
                loadingSection.style.display = 'none';
                showUploadSuccess(extractedData.people.length);

            } catch (err) {
                loadingSection.style.display = 'none';
                document.querySelector('.import-section').style.display = 'block';
                showError('Kunde inte lÃ¤sa PDF:en: ' + err.message);
            }
        }

        // Parse schedule data from PDF text
        function parseScheduleFromText(text) {
            const people = [];

            // Weekday mapping
            const weekdays = {
                'mÃ¥ndag': 'MÃ¥ndag', 'mÃ¥n': 'MÃ¥ndag',
                'tisdag': 'Tisdag', 'tis': 'Tisdag',
                'onsdag': 'Onsdag', 'ons': 'Onsdag',
                'torsdag': 'Torsdag', 'tor': 'Torsdag',
                'fredag': 'Fredag', 'fre': 'Fredag',
                'lÃ¶rdag': 'LÃ¶rdag', 'lÃ¶r': 'LÃ¶rdag',
                'sÃ¶ndag': 'SÃ¶ndag', 'sÃ¶n': 'SÃ¶ndag'
            };

            // Try to find person name from "AnstÃ¤llningsnr XXXXX - Name" pattern
            const nameMatch = text.match(/AnstÃ¤llningsnr\s*\d+\s*[-â€“]\s*([A-ZÃ…Ã„Ã–a-zÃ¥Ã¤Ã¶]+\s+[A-ZÃ…Ã„Ã–a-zÃ¥Ã¤Ã¶]+)/i);
            let personName = nameMatch ? nameMatch[1].trim() : null;

            // Alternative: Try "Work_XXXXX_Firstname_Lastname" from filename pattern in text
            if (!personName) {
                const fileNameMatch = text.match(/Work[_\s]*\d+[_\s]*([A-ZÃ…Ã„Ã–a-zÃ¥Ã¤Ã¶]+)[_\s]+([A-ZÃ…Ã„Ã–a-zÃ¥Ã¤Ã¶]+)/i);
                if (fileNameMatch) {
                    personName = `${fileNameMatch[1]} ${fileNameMatch[2]}`;
                }
            }

            if (!personName) {
                personName = 'OkÃ¤nd';
            }

            const currentPerson = { name: personName, entries: [] };
            people.push(currentPerson);

            // Pattern for schedule rows: Weekday YYYY-MM-DD ServiceCode Time
            // Example: "Torsdag 2026-01-01 17203 04:16 - 10:14"
            // Or: "LÃ¶rdag 2026-01-03 FRIDAG FRIDAG"
            // Or: "MÃ¥ndag 2026-01-05 FACKEXP 08:00 - 17:00"

            // Match pattern: Weekday + Date (YYYY-MM-DD) + Service + optional Time
            // Service can be: 5-digit number, any word (letters, possibly with numbers/slashes), or combinations
            // This flexible pattern catches all service types including unknown ones like FACKEXP, FACKM, etc.
            const rowPattern = /(mÃ¥ndag|tisdag|onsdag|torsdag|fredag|lÃ¶rdag|sÃ¶ndag)\s+(\d{4}-\d{2}-\d{2})\s+(\*?\s*(?:\d{4,5}[A-Z]?|[A-ZÃ…Ã„Ã–][A-ZÃ…Ã„Ã–0-9\-\/]*[A-ZÃ…Ã„Ã–0-9]|[A-ZÃ…Ã„Ã–]+))\s*(?:(\d{1,2}:\d{2})\s*[-â€“]\s*(\d{1,2}:\d{2}))?/gi;

            let match;
            while ((match = rowPattern.exec(text)) !== null) {
                const weekday = weekdays[match[1].toLowerCase()] || match[1];
                const dateStr = match[2]; // YYYY-MM-DD
                const service = match[3].replace(/^\*\s*/, '').trim(); // Remove * prefix
                const startTime = match[4] || '';
                const endTime = match[5] || '';

                // Format date as DD/MM/YYYY to preserve year information
                const dateParts = dateStr.split('-');
                const formattedDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;

                // Format time
                let time = '';
                if (startTime && endTime) {
                    time = `${startTime}-${endTime}`;
                }

                // Determine service display - distinguish between FP (FRIDAG), FPV (FV/FP2/FP-V), Semester, FrÃ¥nvarande, FÃ¶rÃ¤ldraledighet, AFD
                let finalService = service;
                const serviceUpper = service.toUpperCase();
                if (serviceUpper === 'FRIDAG') {
                    finalService = 'FP';
                } else if (serviceUpper.includes('FV') || serviceUpper.includes('FP2') || serviceUpper.includes('FP-V')) {
                    finalService = 'FPV';
                } else if (serviceUpper === 'SEMESTER') {
                    finalService = 'Semester';
                } else if (serviceUpper === 'FRÃ…NVARANDE') {
                    finalService = 'FrÃ¥nvarande';
                } else if (serviceUpper.startsWith('FÃ–RÃ„LDRALEDIGHET')) {
                    finalService = 'FÃ¶rÃ¤ldraledighet';
                } else if (serviceUpper === 'AFD') {
                    finalService = 'AFD';
                }

                currentPerson.entries.push({
                    weekday: weekday,
                    date: formattedDate,
                    time: time,
                    service: finalService
                });
            }

            // If no matches with the main pattern, try a more flexible approach
            if (currentPerson.entries.length === 0) {
                // Fallback: Look for date patterns and times separately
                // Uses same flexible service matching as main pattern
                const dateTimePattern = /(\d{4}-\d{2}-\d{2})\s+(\*?\s*(?:\d{4,5}[A-Z]?|[A-ZÃ…Ã„Ã–][A-ZÃ…Ã„Ã–0-9\-\/]*[A-ZÃ…Ã„Ã–0-9]|[A-ZÃ…Ã„Ã–]+))\s*(?:(\d{1,2}:\d{2})\s*[-â€“]\s*(\d{1,2}:\d{2}))?/gi;

                while ((match = dateTimePattern.exec(text)) !== null) {
                    const dateStr = match[1];
                    const service = match[2].replace(/^\*\s*/, '').trim();
                    const startTime = match[3] || '';
                    const endTime = match[4] || '';

                    const dateParts = dateStr.split('-');
                    const formattedDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;

                    // Determine weekday from date
                    const dateObj = new Date(dateStr);
                    const weekdayNames = ['SÃ¶ndag', 'MÃ¥ndag', 'Tisdag', 'Onsdag', 'Torsdag', 'Fredag', 'LÃ¶rdag'];
                    const weekday = weekdayNames[dateObj.getDay()];

                    let time = '';
                    if (startTime && endTime) {
                        time = `${startTime}-${endTime}`;
                    }

                    let finalService = service;
                    const serviceUpperFallback = service.toUpperCase();
                    if (serviceUpperFallback === 'FRIDAG') {
                        finalService = 'FP';
                    } else if (serviceUpperFallback.includes('FV') || serviceUpperFallback.includes('FP2') || serviceUpperFallback.includes('FP-V')) {
                        finalService = 'FPV';
                    } else if (serviceUpperFallback === 'SEMESTER') {
                        finalService = 'Semester';
                    } else if (serviceUpperFallback === 'FRÃ…NVARANDE') {
                        finalService = 'FrÃ¥nvarande';
                    } else if (serviceUpperFallback.startsWith('FÃ–RÃ„LDRALEDIGHET')) {
                        finalService = 'FÃ¶rÃ¤ldraledighet';
                    } else if (serviceUpperFallback === 'AFD') {
                        finalService = 'AFD';
                    }

                    currentPerson.entries.push({
                        weekday: weekday,
                        date: formattedDate,
                        time: time,
                        service: finalService
                    });
                }
            }

            // Filter out people with no entries
            const validPeople = people.filter(p => p.entries && p.entries.length > 0);

            return { people: validPeople };
        }

        // LocalStorage functions
        // ============================================
        // FIREBASE DATA STORAGE
        // ============================================

        // Sync indicator functions
        function setSyncStatus(status) {
            const indicator = document.getElementById('syncIndicator');
            if (!indicator) return;

            indicator.classList.remove('online', 'offline', 'syncing');

            switch(status) {
                case 'syncing':
                    indicator.classList.add('syncing', 'online');
                    break;
                case 'online':
                    indicator.classList.add('online');
                    break;
                case 'offline':
                    indicator.classList.add('offline');
                    break;
            }
        }

        // Save to Firebase (and localStorage as backup)
        function saveToFirebase() {
            try {
                // Save to localStorage as backup
                if (storage) {
                    storage.setItem('scheduleData', JSON.stringify(scheduleData));
                }

                // Show syncing status
                setSyncStatus('syncing');

                // Save to Firebase
                schedulesRef.set(scheduleData).then(() => {
                    console.log('Schema sparat till Firebase');
                    setSyncStatus('online');
                }).catch((error) => {
                    console.log('Kunde inte spara till Firebase:', error);
                    setSyncStatus('offline');
                });
            } catch (e) {
                console.log('Kunde inte spara:', e);
                setSyncStatus('offline');
            }
        }

        // Legacy function name for compatibility
        function saveToLocalStorage() {
            saveToFirebase();
        }

        // Load from Firebase
        function loadFromFirebase() {
            setSyncStatus('syncing');
            return new Promise((resolve) => {
                schedulesRef.once('value').then((snapshot) => {
                    const data = snapshot.val();
                    if (data && data.people) {
                        scheduleData = data;
                        console.log('Schema laddat frÃ¥n Firebase');
                        setSyncStatus('online');
                        // Also save to localStorage as backup
                        if (storage) {
                            storage.setItem('scheduleData', JSON.stringify(scheduleData));
                        }
                        resolve(true);
                    } else {
                        // Try localStorage as fallback
                        if (storage) {
                            const saved = storage.getItem('scheduleData');
                            if (saved) {
                                scheduleData = JSON.parse(saved);
                                console.log('Schema laddat frÃ¥n localStorage (backup)');
                                // Upload to Firebase
                                saveToFirebase();
                                resolve(true);
                                return;
                            }
                        }
                        setSyncStatus('online');
                        resolve(false);
                    }
                }).catch((error) => {
                    console.log('Kunde inte lÃ¤sa frÃ¥n Firebase:', error);
                    setSyncStatus('offline');
                    // Try localStorage as fallback
                    if (storage) {
                        const saved = storage.getItem('scheduleData');
                        if (saved) {
                            scheduleData = JSON.parse(saved);
                            console.log('Schema laddat frÃ¥n localStorage (offline)');
                            resolve(true);
                            return;
                        }
                    }
                    resolve(false);
                });
            });
        }

        // Listen for real-time updates from Firebase
        function setupFirebaseListener() {
            schedulesRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && data.people) {
                    scheduleData = data;
                    // Update localStorage backup
                    if (storage) {
                        storage.setItem('scheduleData', JSON.stringify(scheduleData));
                    }
                    // Refresh current view
                    const activePage = document.querySelector('.page.active');
                    if (activePage) {
                        if (activePage.id === 'page-today') {
                            renderTodayWorkers();
                        } else if (activePage.id === 'page-schedules') {
                            renderSchedulesList();
                        }
                    }
                }
            });
        }

        // Initialize data loading
        let dataLoaded = false;
        loadFromFirebase().then((loaded) => {
            dataLoaded = loaded;
            if (loaded) {
                renderTodayWorkers();
            }
            // Setup real-time listener
            setupFirebaseListener();
        });

        // Show toast notification
        function showToast(message) {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 2rem;
                left: 50%;
                transform: translateX(-50%);
                background: var(--success);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 50px;
                font-weight: 500;
                z-index: 3000;
                animation: fadeIn 0.3s ease-out;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }


        // Track if we came from "today" page to return there when closing schedule
        let cameFromToday = false;

        function openPersonModal(personName) {
            const person = scheduleData.people.find(p => p.name === personName);
            if (!person) return;

            // Find person index in schedule data
            const personIndex = scheduleData.people.findIndex(p => p.name === personName);
            if (personIndex === -1) return;

            // Remember we came from today's page
            cameFromToday = true;

            // Navigate to schedules page and open the person's schedule
            navigateTo('schedules');

            // Small delay to ensure page is rendered, then open the modal
            setTimeout(() => {
                openEditScheduleModal(personIndex);
            }, 100);
        }

        function closeModal() {
            personModal.classList.remove('active');
        }

        // Save schema to JSON

        function saveScheduleToJson() {
            if (!scheduleData || !scheduleData.people) {
                showError('Inget schema att spara.');
                return;
            }

            const dataStr = JSON.stringify(scheduleData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const now = new Date();
            const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            const fileName = `schema-${dateStr}.json`;

            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // File input change handler
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFile(e.target.files[0]);
            }
        });

        function showUploadSuccess(personCount) {
            successText.textContent = `${personCount} schema har importerats`;
            uploadSuccess.style.display = 'block';
            document.querySelector('.import-section').style.display = 'none';
        }

        function mergeScheduleData(newData) {
            if (!newData.people) return;

            newData.people.forEach(newPerson => {
                const existingPerson = scheduleData.people.find(
                    p => p.name.toLowerCase() === newPerson.name.toLowerCase()
                );

                if (existingPerson) {
                    // Merge entries - avoid duplicates
                    newPerson.entries.forEach(newEntry => {
                        const isDuplicate = existingPerson.entries.some(
                            e => e.date === newEntry.date && e.time === newEntry.time
                        );
                        if (!isDuplicate) {
                            existingPerson.entries.push(newEntry);
                        }
                    });
                } else {
                    // Add new person
                    scheduleData.people.push(newPerson);
                }
            });
        }


        function normalizeDate(dateStr) {
            // Try to parse various date formats and return { day, month, year }
            if (!dateStr) return null;

            const cleaned = dateStr.trim();

            // Format: DD/MM or DD/MM/YYYY
            let match = cleaned.match(/^(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?$/);
            if (match) {
                return {
                    day: parseInt(match[1], 10),
                    month: parseInt(match[2], 10),
                    year: match[3] ? parseInt(match[3], 10) : null
                };
            }

            // Format: DD-MM or DD-MM-YYYY
            match = cleaned.match(/^(\d{1,2})-(\d{1,2})(?:-(\d{2,4}))?$/);
            if (match) {
                return {
                    day: parseInt(match[1], 10),
                    month: parseInt(match[2], 10),
                    year: match[3] ? parseInt(match[3], 10) : null
                };
            }

            // Format: YYYY-MM-DD
            match = cleaned.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
            if (match) {
                return {
                    day: parseInt(match[3], 10),
                    month: parseInt(match[2], 10),
                    year: parseInt(match[1], 10)
                };
            }

            // Format: DD.MM or DD.MM.YYYY
            match = cleaned.match(/^(\d{1,2})\.(\d{1,2})(?:\.(\d{2,4}))?$/);
            if (match) {
                return {
                    day: parseInt(match[1], 10),
                    month: parseInt(match[2], 10),
                    year: match[3] ? parseInt(match[3], 10) : null
                };
            }

            return null;
        }

        function datesMatch(entryDate, targetDate) {
            const parsed = normalizeDate(entryDate);
            if (!parsed) return false;

            const targetDay = targetDate.getDate();
            const targetMonth = targetDate.getMonth() + 1;
            const targetYear = targetDate.getFullYear();

            // Check day and month
            if (parsed.day !== targetDay || parsed.month !== targetMonth) {
                return false;
            }

            // If year is specified, check it too
            if (parsed.year !== null) {
                const entryYear = parsed.year < 100 ? 2000 + parsed.year : parsed.year;
                if (entryYear !== targetYear) {
                    return false;
                }
            }

            return true;
        }

        function renderTodayWorkers() {
            if (!scheduleData || !scheduleData.people || scheduleData.people.length === 0) {
                todayWorkersList.innerHTML = `
                    <div class="no-data-message">
                        <div class="no-data-icon">ðŸ“‹</div>
                        <div class="no-data-title">Inget schema laddat</div>
                        <div class="no-data-text">Ladda upp ett schema fÃ¶r att se vem som jobbar</div>
                        <button class="link-btn" onclick="navigateTo('upload')">Ladda upp schema</button>
                    </div>
                `;
                return;
            }

            const targetWeekday = ['SÃ¶ndag', 'MÃ¥ndag', 'Tisdag', 'Onsdag', 'Torsdag', 'Fredag', 'LÃ¶rdag'][selectedDate.getDay()];

            const workersToday = [];
            const freeToday = [];

            scheduleData.people.forEach(person => {
                if (person.entries) {
                    person.entries.forEach(entry => {
                        // Check if date matches (primary check)
                        const matchesDate = datesMatch(entry.date, selectedDate);

                        // Only use weekday as fallback if entry has NO parseable date
                        const hasDate = normalizeDate(entry.date) !== null;
                        const matchesWeekday = !hasDate && entry.weekday &&
                            entry.weekday.toLowerCase() === targetWeekday.toLowerCase();

                        if (matchesDate || matchesWeekday) {
                            const isFree = isServiceFree(entry.service);

                            // Check if this person is already added (avoid duplicates)
                            const targetList = isFree ? freeToday : workersToday;
                            const alreadyAdded = targetList.some(w =>
                                w.name === person.name && w.time === entry.time && w.service === entry.service
                            );
                            if (!alreadyAdded) {
                                targetList.push({
                                    name: person.name,
                                    time: entry.time,
                                    service: entry.service,
                                    isFree: isFree
                                });
                            }
                        }
                    });
                }
            });

            // Combine lists based on includeFree setting
            let displayList = [...workersToday];
            if (includeFree) {
                displayList = displayList.concat(freeToday);
            }

            // Build filter row HTML
            const filterRowHtml = `
                <div class="filter-row">
                    <div class="person-count">ðŸ‘¥ <strong>${workersToday.length}</strong> arbetar${includeFree && freeToday.length > 0 ? `, <strong>${freeToday.length}</strong> lediga` : ''}</div>
                    <label class="include-free-checkbox">
                        <input type="checkbox" id="includeFreeCheckbox" ${includeFree ? 'checked' : ''}>
                        Lediga
                    </label>
                </div>
            `;

            if (displayList.length === 0) {
                todayWorkersList.innerHTML = filterRowHtml + `
                    <div class="no-data-message">
                        <div class="no-data-icon">ðŸ–ï¸</div>
                        <div class="no-data-title">Ingen arbetar denna dag</div>
                        <div class="no-data-text">Enligt det laddade schemat finns inga arbetspass fÃ¶r valt datum</div>
                    </div>
                `;
                // Re-attach checkbox listener
                attachCheckboxListener();
                return;
            }

            // Sort by start time (free people go to end if included)
            displayList.sort((a, b) => {
                // If includeFree, put working people first
                if (a.isFree !== b.isFree) {
                    return a.isFree ? 1 : -1;
                }
                const timeA = parseStartTime(a.time);
                const timeB = parseStartTime(b.time);
                return timeA - timeB;
            });

            let html = filterRowHtml;
            displayList.forEach((worker, index) => {
                const initials = worker.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                const serviceIcon = getServiceIcon(worker.service);
                const serviceClass = worker.isFree ? 'service-free' : 'service-badge';
                const displayService = formatServiceDisplay(worker.service);
                const timeDisplay = worker.isFree ? 'Ledig' : escapeHtml(worker.time || '-');
                const freeClass = worker.isFree ? ' free-day' : '';
                html += `
                    <div class="worker-card clickable${freeClass}" style="animation-delay: ${index * 0.02}s" onclick="openPersonModal('${escapeHtml(worker.name).replace(/'/g, "\\'")}')">
                        <div class="worker-avatar">${initials}</div>
                        <div class="worker-info">
                            <span class="worker-name">${escapeHtml(worker.name)}</span>
                            <span class="worker-time">${timeDisplay}</span>
                        </div>
                        <div class="worker-service">
                            <div class="service-container">
                                ${serviceIcon}
                            </div>
                        </div>
                    </div>
                `;
            });

            todayWorkersList.innerHTML = html;

            // Re-attach checkbox listener
            attachCheckboxListener();
        }

        function attachCheckboxListener() {
            const checkbox = document.getElementById('includeFreeCheckbox');
            if (checkbox) {
                checkbox.addEventListener('change', (e) => {
                    includeFree = e.target.checked;
                    renderTodayWorkers();
                });
            }
        }

        // Current selected month filter (null = all months)
        let selectedMonth = null;

        // Get available months from schedule data
        function getAvailableMonths() {
            const months = new Set();
            if (!scheduleData || !scheduleData.people) return [];

            scheduleData.people.forEach(person => {
                if (person.entries) {
                    person.entries.forEach(entry => {
                        const parsed = normalizeDate(entry.date);
                        if (parsed && parsed.month) {
                            // Store as "YYYY-MM" or just "MM" with assumed year
                            const year = parsed.year || new Date().getFullYear();
                            months.add(`${year}-${String(parsed.month).padStart(2, '0')}`);
                        }
                    });
                }
            });

            return Array.from(months).sort();
        }

        // Get month name in Swedish (short format: "Jan 26")
        function getMonthName(monthStr) {
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Maj', 'Jun',
                               'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dec'];
            const parts = monthStr.split('-');
            const monthIndex = parseInt(parts[1], 10) - 1;
            const year = parts[0].slice(-2);
            return `${monthNames[monthIndex]} ${year}`;
        }

        // Count FP and FPV for a person across ALL entries (cumulative for the year)
        function countFPForPerson(person) {
            let fpCount = 0;  // FRIDAG count (target: 104/year)
            let fpvCount = 0; // FV/FP2/FP-V count (target: 14/year)

            if (!person.entries) return { fpCount, fpvCount };

            person.entries.forEach(entry => {
                const s = (entry.service || '').toUpperCase().trim();
                // FP = FRIDAG (also count legacy "Fri" as FP if it's not FPV)
                if (s === 'FP' || s === 'FRIDAG' || s === 'FRI') {
                    fpCount++;
                }
                // FPV = FV/FP2/FP-V combinations
                else if (s === 'FPV' || s === 'FV' || s === 'FP2' || s === 'FP-V' ||
                         s.includes('FV') || s.includes('FP2') || s.includes('FP-V')) {
                    fpvCount++;
                }
            });

            return { fpCount, fpvCount };
        }

        // Count entries for selected month (for filtering display)
        function hasEntriesForMonth(person, monthFilter) {
            if (!person.entries || !monthFilter) return true;

            return person.entries.some(entry => {
                const parsed = normalizeDate(entry.date);
                if (parsed) {
                    const year = parsed.year || new Date().getFullYear();
                    const entryMonth = `${year}-${String(parsed.month).padStart(2, '0')}`;
                    return entryMonth === monthFilter;
                }
                return false;
            });
        }

        function renderSchedulesList() {
            const container = document.getElementById('schedulesListContainer');

            if (!scheduleData || !scheduleData.people || scheduleData.people.length === 0) {
                container.innerHTML = `
                    <div class="no-data-message">
                        <div class="no-data-icon">ðŸ“‹</div>
                        <div class="no-data-title">Inga scheman</div>
                        <div class="no-data-text">Ladda upp scheman fÃ¶r att se dem hÃ¤r</div>
                        <button class="link-btn" onclick="navigateTo('upload')">Ladda upp schema</button>
                    </div>
                `;
                return;
            }

            // Get available months
            const availableMonths = getAvailableMonths();

            // Auto-select first month if none selected
            if (selectedMonth === null && availableMonths.length > 0) {
                selectedMonth = availableMonths[0];
            }

            // Build month selector (without "Alla" button)
            let monthSelectorHtml = `<div class="month-selector">`;
            availableMonths.forEach(month => {
                monthSelectorHtml += `
                    <button class="month-btn ${selectedMonth === month ? 'active' : ''}" onclick="selectMonth('${month}')">${getMonthName(month)}</button>
                `;
            });
            monthSelectorHtml += '</div>';

            let html = `
                ${monthSelectorHtml}
                <div class="schedules-summary-compact">
                    <span class="schedules-count">ðŸ‘¥ ${scheduleData.people.length} personer</span>
                    <button class="clear-btn-small" onclick="clearAllSchedules()">Rensa allt</button>
                </div>
            `;

            scheduleData.people.forEach((person, personIndex) => {
                const counts = countFPForPerson(person);

                // Skip if no entries for selected month
                if (selectedMonth && !hasEntriesForMonth(person, selectedMonth)) {
                    return;
                }

                html += `
                    <div class="schedule-list-item" id="schedule-item-${personIndex}">
                        <div class="schedule-list-header" onclick="cameFromToday = false; openEditScheduleModal(${personIndex})">
                            <div>
                                <div class="schedule-list-name">${escapeHtml(person.name)}</div>
                                <div class="schedule-list-meta">ðŸ–ï¸ ${counts.fpCount}/104 FP Â· ðŸ“… ${counts.fpvCount}/14 FPV</div>
                            </div>
                            <div class="schedule-list-actions">
                                <button class="schedule-list-btn delete" onclick="event.stopPropagation(); confirmDeletePerson('${escapeHtml(person.name).replace(/'/g, "\\'")}')">ðŸ—‘ï¸</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function selectMonth(month) {
            selectedMonth = month;
            renderSchedulesList();
        }

        function openEditScheduleModal(personIndex) {
            const person = scheduleData.people[personIndex];
            if (!person) return;

            let entriesHtml = '';
            if (person.entries && person.entries.length > 0) {
                person.entries.forEach((entry, entryIndex) => {
                    const serviceIcon = getServiceIcon(entry.service);
                    const displayService = formatServiceDisplay(entry.service);
                    const serviceClass = isServiceFree(entry.service) ? 'service-free' : 'service-badge';
                    // Format date as day/month (without year for display)
                    let displayDate = entry.date || '-';
                    if (entry.date && entry.date.includes('/')) {
                        // Extract just DD/MM from DD/MM/YYYY if year is present
                        const dateParts = entry.date.split('/');
                        displayDate = dateParts.length >= 2 ? `${dateParts[0]}/${dateParts[1]}` : entry.date;
                    }

                    // Shorten weekday for mobile (MÃ¥ndag â†’ MÃ¥n)
                    const shortWeekdays = {
                        'MÃ¥ndag': 'MÃ¥n', 'Tisdag': 'Tis', 'Onsdag': 'Ons',
                        'Torsdag': 'Tor', 'Fredag': 'Fre', 'LÃ¶rdag': 'LÃ¶r', 'SÃ¶ndag': 'SÃ¶n'
                    };
                    const displayWeekday = shortWeekdays[entry.weekday] || entry.weekday || '-';

                    entriesHtml += `
                        <tr>
                            <td>${escapeHtml(displayWeekday)}</td>
                            <td>${escapeHtml(displayDate)}</td>
                            <td>
                                <span class="editable-cell" onclick="openEditTimeModal(${personIndex}, ${entryIndex})">${escapeHtml(entry.time || '-')}</span>
                            </td>
                            <td>
                                <div class="service-container">
                                    <span class="editable-cell ${serviceClass}" onclick="openEditServiceModal(${personIndex}, ${entryIndex})">${escapeHtml(displayService || '-')}</span>
                                    ${serviceIcon}
                                </div>
                            </td>
                        </tr>
                    `;
                });
            } else {
                entriesHtml = '<tr><td colspan="4" style="text-align: center;">Inga schemauppgifter</td></tr>';
            }

            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'editScheduleModal';
            modal.style.cssText = 'padding: 0;';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 100%; width: 100%; height: 100%; max-height: 100%; border-radius: 0; display: flex; flex-direction: column;">
                    <div class="modal-header" style="display: flex; align-items: center; gap: 1rem; padding-top: calc(1.25rem + env(safe-area-inset-top)); min-height: 56px;">
                        <button class="modal-close" onclick="closeEditScheduleModal()" style="position: static; order: -1; min-width: 44px; min-height: 44px;">âœ•</button>
                        <h2 class="modal-title" style="flex: 1;">${escapeHtml(person.name)}</h2>
                    </div>
                    <div class="schedule-table-header" style="background: var(--bg-secondary); border-bottom: 2px solid var(--border);">
                        <table class="modal-schedule-table" style="margin: 0;">
                            <thead>
                                <tr>
                                    <th style="background: var(--bg-secondary);">Dag</th>
                                    <th style="background: var(--bg-secondary);">Datum</th>
                                    <th style="background: var(--bg-secondary);">Tid</th>
                                    <th style="background: var(--bg-secondary);">TjÃ¤nst</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                    <div class="modal-body" style="overflow-y: auto; flex: 1; padding-top: 0;">
                        <table class="modal-schedule-table" style="margin: 0;">
                            <tbody>
                                ${entriesHtml}
                            </tbody>
                        </table>
                    </div>
                    <div style="padding: 1rem; border-top: 1px solid var(--border); background: var(--bg-secondary);">
                        <button onclick="exportToCalendar(${personIndex})" style="width: 100%; padding: 0.85rem; background: var(--success); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-family: inherit;">
                            ðŸ“… Spara i kalender
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Close on overlay click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeEditScheduleModal();
            });
        }

        function openEditTimeModal(personIndex, entryIndex) {
            const entry = scheduleData.people[personIndex].entries[entryIndex];
            // Parse existing time (format: "08:00-16:00")
            let startTime = '';
            let endTime = '';
            if (entry.time) {
                const parts = entry.time.split('-');
                if (parts.length >= 1) startTime = parts[0].trim();
                if (parts.length >= 2) endTime = parts[1].trim();
            }

            // Check if already marked as FrÃ¥nvarande
            const isAbsent = (entry.service || '').toUpperCase() === 'FRÃ…NVARANDE';

            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'editFieldModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 350px;">
                    <div class="modal-header">
                        <h2 class="modal-title" style="font-size: 1.1rem;">ðŸ• Ã„ndra tid</h2>
                        <button class="modal-close" onclick="closeEditFieldModal()">âœ•</button>
                    </div>
                    <div class="modal-body" style="padding: 1.5rem;">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary);">Starttid</label>
                            <input type="time" id="editStartTime" value="${startTime}" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 10px; font-size: 16px; background: var(--bg-primary); color: var(--text-primary);">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary);">Sluttid</label>
                            <input type="time" id="editEndTime" value="${endTime}" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 10px; font-size: 16px; background: var(--bg-primary); color: var(--text-primary);">
                        </div>
                        <div style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-primary); border-radius: 10px; border: 2px solid var(--border);">
                            <input type="checkbox" id="editAbsentCheckbox" ${isAbsent ? 'checked' : ''} style="width: 20px; height: 20px; cursor: pointer;">
                            <label for="editAbsentCheckbox" style="font-weight: 500; color: var(--text-primary); cursor: pointer;">FrÃ¥nvarande</label>
                        </div>
                        <button class="btn" style="width: 100%; margin: 0;" onclick="saveTimeEdit(${personIndex}, ${entryIndex})">Spara</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeEditFieldModal();
            });
        }

        function openEditServiceModal(personIndex, entryIndex) {
            const entry = scheduleData.people[personIndex].entries[entryIndex];
            const currentService = entry.service || '';

            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'editFieldModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 350px;">
                    <div class="modal-header">
                        <h2 class="modal-title" style="font-size: 1.1rem;">ðŸ·ï¸ Ã„ndra turnummer</h2>
                        <button class="modal-close" onclick="closeEditFieldModal()">âœ•</button>
                    </div>
                    <div class="modal-body" style="padding: 1.5rem;">
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary);">Turnummer</label>
                            <input type="text" id="editServiceInput" value="${escapeHtml(currentService)}" placeholder="T.ex. T1, Fri, FV..." style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 10px; font-size: 16px; background: var(--bg-primary); color: var(--text-primary);">
                        </div>
                        <button class="btn" style="width: 100%; margin: 0;" onclick="saveServiceEdit(${personIndex}, ${entryIndex})">Spara</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeEditFieldModal();
            });

            // Focus input
            setTimeout(() => {
                document.getElementById('editServiceInput').focus();
            }, 100);
        }

        function closeEditFieldModal() {
            const modal = document.getElementById('editFieldModal');
            if (modal) modal.remove();
        }

        function saveTimeEdit(personIndex, entryIndex) {
            const startTime = document.getElementById('editStartTime').value;
            const endTime = document.getElementById('editEndTime').value;
            const isAbsent = document.getElementById('editAbsentCheckbox').checked;

            const entry = scheduleData.people[personIndex].entries[entryIndex];

            // If marked as FrÃ¥nvarande, set service to FrÃ¥nvarande (time stays unchanged)
            if (isAbsent) {
                entry.service = 'FrÃ¥nvarande';
            } else {
                // If was FrÃ¥nvarande but checkbox is now unchecked, we need to keep the service
                // but update the time
                let timeStr = '';
                if (startTime && endTime) {
                    timeStr = `${startTime}-${endTime}`;
                } else if (startTime) {
                    timeStr = startTime;
                } else if (endTime) {
                    timeStr = endTime;
                }
                entry.time = timeStr;

                // If service was FrÃ¥nvarande and is now unchecked, clear it
                if ((entry.service || '').toUpperCase() === 'FRÃ…NVARANDE') {
                    entry.service = '';
                }
            }

            saveToLocalStorage();
            closeEditFieldModal();
            closeEditScheduleModal();
            openEditScheduleModal(personIndex);
        }

        function saveServiceEdit(personIndex, entryIndex) {
            const newService = document.getElementById('editServiceInput').value.trim();
            const entry = scheduleData.people[personIndex].entries[entryIndex];
            entry.service = newService;

            // If service is changed to a free day type (FP, FPV, Fri, AFD, etc.), clear the time
            const s = newService.toUpperCase();
            if (s === 'FP' || s === 'FPV' || s === 'FRI' || s === 'AFD' ||
                s === 'SEMESTER' || s === 'FRÃ…NVARANDE' || s.startsWith('FÃ–RÃ„LDRALEDIGHET') ||
                s.includes('FV') || s.includes('FP2') || s.includes('FP-V')) {
                entry.time = '';
            }

            saveToLocalStorage();
            closeEditFieldModal();
            closeEditScheduleModal();
            openEditScheduleModal(personIndex);
        }

        function closeEditScheduleModal() {
            const modal = document.getElementById('editScheduleModal');
            if (modal) {
                modal.remove();
            }

            // If we came from today's page, return there
            if (cameFromToday) {
                cameFromToday = false;
                navigateTo('today');
            }
        }

        function confirmDeletePerson(personName) {
            // Create confirmation modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'confirmModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h2 class="modal-title" style="font-size: 1.1rem;">âš ï¸ BekrÃ¤fta borttagning</h2>
                        <button class="modal-close" onclick="closeConfirmModal()">âœ•</button>
                    </div>
                    <div class="modal-body" style="text-align: center; padding: 2rem;">
                        <p style="margin-bottom: 1.5rem;">Ã„r du sÃ¤ker pÃ¥ att du vill ta bort schemat fÃ¶r <strong>${escapeHtml(personName)}</strong>?</p>
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button class="reset-btn" onclick="closeConfirmModal()">Avbryt</button>
                            <button class="btn" style="margin: 0; padding: 0.75rem 1.5rem;" onclick="deletePerson('${escapeHtml(personName).replace(/'/g, "\\'")}')">Ta bort</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeConfirmModal() {
            const modal = document.getElementById('confirmModal');
            if (modal) {
                modal.remove();
            }
        }

        function deletePerson(personName) {
            closeConfirmModal();
            if (scheduleData && scheduleData.people) {
                scheduleData.people = scheduleData.people.filter(p => p.name !== personName);
                saveToLocalStorage();
                renderSchedulesList();
            }
        }

        function clearAllSchedules() {
            // Create confirmation modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'confirmModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h2 class="modal-title" style="font-size: 1.1rem;">âš ï¸ Rensa alla scheman</h2>
                        <button class="modal-close" onclick="closeConfirmModal()">âœ•</button>
                    </div>
                    <div class="modal-body" style="text-align: center; padding: 2rem;">
                        <p style="margin-bottom: 1.5rem;">Ã„r du sÃ¤ker pÃ¥ att du vill ta bort <strong>alla</strong> scheman?</p>
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button class="reset-btn" onclick="closeConfirmModal()">Avbryt</button>
                            <button class="btn" style="margin: 0; padding: 0.75rem 1.5rem;" onclick="confirmClearAll()">Rensa allt</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function confirmClearAll() {
            closeConfirmModal();
            scheduleData = null;
            // Clear from Firebase
            schedulesRef.remove().then(() => {
                console.log('Schema raderat frÃ¥n Firebase');
            }).catch((error) => {
                console.log('Kunde inte radera frÃ¥n Firebase:', error);
            });
            // Clear localStorage
            if (storage) {
                storage.removeItem('scheduleData');
            }
            renderSchedulesList();
            showToast('Alla scheman har raderats');
        }

        function parseStartTime(timeStr) {
            if (!timeStr) return 9999;
            // Extract start time from formats like "08:00-16:00" or "08:00"
            const match = timeStr.match(/^(\d{1,2}):?(\d{2})?/);
            if (match) {
                const hours = parseInt(match[1], 10);
                const minutes = match[2] ? parseInt(match[2], 10) : 0;
                return hours * 60 + minutes;
            }
            return 9999;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function isServiceFree(service) {
            if (!service) return false;
            const s = service.toUpperCase().trim();
            // Check for FP (FRIDAG), FPV (FV/FP2/FP-V), Semester, FrÃ¥nvarande, FÃ¶rÃ¤ldraledighet, AFD, or legacy Fri
            if (s === 'FP' || s === 'FPV' || s === 'FRI' || s === 'FV' || s === 'FP2' || s === 'FP-V' || s === 'FRIDAG' ||
                s === 'SEMESTER' || s === 'FRÃ…NVARANDE' || s === 'AFD') {
                return true;
            }
            // Check for FÃ¶rÃ¤ldraledighet (may have variants like ">5dagar")
            if (s.startsWith('FÃ–RÃ„LDRALEDIGHET')) {
                return true;
            }
            // Also check if service contains these patterns
            if (s.includes('FV') || s.includes('FP2') || s.includes('FP-V') || s.includes('FPV')) {
                return true;
            }
            return false;
        }

        // Export schedule to calendar (.ics file)
        function exportToCalendar(personIndex) {
            const person = scheduleData.people[personIndex];
            if (!person || !person.entries || person.entries.length === 0) {
                showToast('Inga schemauppgifter att exportera');
                return;
            }

            // Generate ICS content
            let icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//Schemahanterare//Schema Export//SV',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH',
                `X-WR-CALNAME:${person.name} - Arbetsschema`
            ];

            person.entries.forEach((entry, index) => {
                // Skip free days
                if (isServiceFree(entry.service)) return;

                // Parse date from entry.date (format: DD/MM or DD/MM/YYYY)
                const parsed = normalizeDate(entry.date);
                if (!parsed) return;

                const year = parsed.year || new Date().getFullYear();
                const month = String(parsed.month).padStart(2, '0');
                const day = String(parsed.day).padStart(2, '0');

                // Parse time (format: "08:00-16:00")
                let startHour = '08', startMin = '00';
                let endHour = '16', endMin = '00';

                if (entry.time && entry.time.includes('-')) {
                    const timeParts = entry.time.split('-');
                    if (timeParts[0]) {
                        const start = timeParts[0].trim().split(':');
                        startHour = start[0] || '08';
                        startMin = start[1] || '00';
                    }
                    if (timeParts[1]) {
                        const end = timeParts[1].trim().split(':');
                        endHour = end[0] || '16';
                        endMin = end[1] || '00';
                    }
                }

                // Format dates for ICS (YYYYMMDDTHHMMSS)
                const dtStart = `${year}${month}${day}T${startHour.padStart(2, '0')}${startMin.padStart(2, '0')}00`;
                const dtEnd = `${year}${month}${day}T${endHour.padStart(2, '0')}${endMin.padStart(2, '0')}00`;

                // Create unique ID
                const uid = `${year}${month}${day}-${index}-${Date.now()}@schemahanterare`;

                // Event title
                const title = entry.service ? `Arbete: ${entry.service}` : 'Arbetspass';

                icsContent.push('BEGIN:VEVENT');
                icsContent.push(`UID:${uid}`);
                icsContent.push(`DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z`);
                icsContent.push(`DTSTART:${dtStart}`);
                icsContent.push(`DTEND:${dtEnd}`);
                icsContent.push(`SUMMARY:${title}`);
                icsContent.push(`DESCRIPTION:${person.name} - ${entry.weekday || ''} ${entry.date}`);
                icsContent.push('END:VEVENT');
            });

            icsContent.push('END:VCALENDAR');

            const icsString = icsContent.join('\r\n');

            // Detect iOS
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
                         (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

            if (isIOS) {
                // On iOS, use data URI to trigger native calendar import
                const dataUri = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(icsString);
                window.location.href = dataUri;
                showToast('Ã–ppnar Kalender...');
            } else {
                // On other devices, download the file
                const blob = new Blob([icsString], { type: 'text/calendar;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${person.name.replace(/\s+/g, '_')}_schema.ics`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showToast('Kalender exporterad!');
            }
        }

        function formatServiceDisplay(service) {
            if (!service) return service;
            const s = service.toUpperCase().trim();
            // FP displays as "FP" (was FRIDAG)
            if (s === 'FP') {
                return 'FP';
            }
            // FPV displays as "FPV" (was FV/FP2/FP-V)
            if (s === 'FPV') {
                return 'FPV';
            }
            // Semester, FrÃ¥nvarande, FÃ¶rÃ¤ldraledighet, AFD display as "Fri" on "Vem jobbar idag?"
            if (s === 'SEMESTER' || s === 'FRÃ…NVARANDE' || s === 'AFD' || s.startsWith('FÃ–RÃ„LDRALEDIGHET')) {
                return 'Fri';
            }
            // Legacy support for old data
            if (s === 'FRI') {
                return 'Fri';
            }
            return service;
        }

        function getServiceIcon(service) {
            if (!service || isServiceFree(service)) {
                return '';
            }

            const serviceUpper = service.toUpperCase().trim();

            // Check for "Reserv" (alone or followed by a number) â†’ "Extra reserv"
            if (/^RESERV/i.test(serviceUpper)) {
                return '<div class="service-icon icon-text">Extra<br>reserv</div>';
            }

            // Get characters from the service string (remove spaces)
            const chars = serviceUpper.replace(/\s/g, '');

            // Need at least 3 characters to check rules
            if (chars.length >= 3) {
                const thirdChar = chars[2];   // Position 3
                const fourthChar = chars.length >= 4 ? chars[3] : '';  // Position 4
                const sixthChar = chars.length >= 6 ? chars[5] : '';   // Position 6

                // If 4th char is 8 â†’ "TÃ¥g reserv"
                if (fourthChar === '8') {
                    return '<div class="service-icon icon-text">TÃ¥g<br>reserv</div>';
                }

                // If 4th char is 9 â†’ "Reserv"
                if (fourthChar === '9') {
                    return '<div class="service-icon icon-text">Reserv</div>';
                }

                // If 6th char is A â†’ "Dag 1" (torn at bottom)
                if (sixthChar === 'A') {
                    return '<div class="service-icon icon-dag1">Dag 1</div>';
                }

                // If 6th char is B â†’ "Dag 2" (torn at top)
                if (sixthChar === 'B') {
                    return '<div class="service-icon icon-dag2">Dag 2</div>';
                }

                // Check if 3rd character is a digit for flag logic
                if (/\d/.test(thirdChar)) {
                    const digit = parseInt(thirdChar, 10);
                    if (digit % 2 === 0) {
                        // Even (0, 2, 4, 6) â†’ Danish flag
                        return '<div class="service-icon flag-denmark"></div>';
                    } else {
                        // Odd (1, 3, 5, 7, 9) â†’ Swedish flag
                        return '<div class="service-icon flag-sweden"></div>';
                    }
                }
            }

            return '';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }

    </script>
</body>
</html>
